import{u as K,p as _t,F as Q,S as Tt,d as Ot,V as Et,m as Dt}from"./index-58a76124.js";const mt=1024;let Lt=0;class lt{constructor(t,e){this.from=t,this.to=e}}class m{constructor(t={}){this.id=Lt++,this.perNode=!!t.perNode,this.deserialize=t.deserialize||(()=>{throw new Error("This node type doesn't define a deserialize function")})}add(t){if(this.perNode)throw new RangeError("Can't add per-node props to node types");return typeof t!="function"&&(t=N.match(t)),e=>{let r=t(e);return r===void 0?null:[this,r]}}}m.closedBy=new m({deserialize:s=>s.split(" ")}),m.openedBy=new m({deserialize:s=>s.split(" ")}),m.group=new m({deserialize:s=>s.split(" ")}),m.contextHash=new m({perNode:!0}),m.lookAhead=new m({perNode:!0}),m.mounted=new m({perNode:!0});const Wt=Object.create(null);class N{constructor(t,e,r,i=0){this.name=t,this.props=e,this.id=r,this.flags=i}static define(t){let e=t.props&&t.props.length?Object.create(null):Wt,r=(t.top?1:0)|(t.skipped?2:0)|(t.error?4:0)|(t.name==null?8:0),i=new N(t.name||"",e,t.id,r);if(t.props){for(let n of t.props)if(Array.isArray(n)||(n=n(i)),n){if(n[0].perNode)throw new RangeError("Can't store a per-node prop on a node type");e[n[0].id]=n[1]}}return i}prop(t){return this.props[t.id]}get isTop(){return(this.flags&1)>0}get isSkipped(){return(this.flags&2)>0}get isError(){return(this.flags&4)>0}get isAnonymous(){return(this.flags&8)>0}is(t){if(typeof t=="string"){if(this.name==t)return!0;let e=this.prop(m.group);return e?e.indexOf(t)>-1:!1}return this.id==t}static match(t){let e=Object.create(null);for(let r in t)for(let i of r.split(" "))e[i]=t[r];return r=>{for(let i=r.prop(m.group),n=-1;n<(i?i.length:0);n++){let l=e[n<0?r.name:i[n]];if(l)return l}}}}N.none=new N("",Object.create(null),0,8);class ht{constructor(t){this.types=t;for(let e=0;e<t.length;e++)if(t[e].id!=e)throw new RangeError("Node type ids should correspond to array positions when creating a node set")}extend(...t){let e=[];for(let r of this.types){let i=null;for(let n of t){let l=n(r);l&&(i||(i=Object.assign({},r.props)),i[l[0].id]=l[1])}e.push(i?new N(r.name,i,r.id,r.flags):r)}return new ht(e)}}const tt=new WeakMap,wt=new WeakMap;class S{constructor(t,e,r,i,n){if(this.type=t,this.children=e,this.positions=r,this.length=i,this.props=null,n&&n.length){this.props=Object.create(null);for(let[l,h]of n)this.props[typeof l=="number"?l:l.id]=h}}toString(){let t=this.prop(m.mounted);if(t&&!t.overlay)return t.tree.toString();let e="";for(let r of this.children){let i=r.toString();i&&(e&&(e+=","),e+=i)}return this.type.name?(/\W/.test(this.type.name)&&!this.type.isError?JSON.stringify(this.type.name):this.type.name)+(e.length?"("+e+")":""):e}cursor(t,e=0){let r=t!=null&&tt.get(this)||this.topNode,i=new rt(r);return t!=null&&(i.moveTo(t,e),tt.set(this,i._tree)),i}fullCursor(){return new rt(this.topNode,1)}get topNode(){return new O(this,0,0,null)}resolve(t,e=0){let r=$(tt.get(this)||this.topNode,t,e,!1);return tt.set(this,r),r}resolveInner(t,e=0){let r=$(wt.get(this)||this.topNode,t,e,!0);return wt.set(this,r),r}iterate(t){let{enter:e,leave:r,from:i=0,to:n=this.length}=t;for(let l=this.cursor(),h=()=>l.node;;){let o=!1;if(l.from<=n&&l.to>=i&&(l.type.isAnonymous||e(l.type,l.from,l.to,h)!==!1)){if(l.firstChild())continue;l.type.isAnonymous||(o=!0)}for(;o&&r&&r(l.type,l.from,l.to,h),o=l.type.isAnonymous,!l.nextSibling();){if(!l.parent())return;o=!0}}}prop(t){return t.perNode?this.props?this.props[t.id]:void 0:this.type.prop(t)}get propValues(){let t=[];if(this.props)for(let e in this.props)t.push([+e,this.props[e]]);return t}balance(t={}){return this.children.length<=8?this:ft(N.none,this.children,this.positions,0,this.children.length,0,this.length,(e,r,i)=>new S(this.type,e,r,i,this.propValues),t.makeTree||((e,r,i)=>new S(N.none,e,r,i)))}static build(t){return Mt(t)}}S.empty=new S(N.none,[],[],0);class ot{constructor(t,e){this.buffer=t,this.index=e}get id(){return this.buffer[this.index-4]}get start(){return this.buffer[this.index-3]}get end(){return this.buffer[this.index-2]}get size(){return this.buffer[this.index-1]}get pos(){return this.index}next(){this.index-=4}fork(){return new ot(this.buffer,this.index)}}class M{constructor(t,e,r){this.buffer=t,this.length=e,this.set=r}get type(){return N.none}toString(){let t=[];for(let e=0;e<this.buffer.length;)t.push(this.childString(e)),e=this.buffer[e+3];return t.join(",")}childString(t){let e=this.buffer[t],r=this.buffer[t+3],i=this.set.types[e],n=i.name;if(/\W/.test(n)&&!i.isError&&(n=JSON.stringify(n)),t+=4,r==t)return n;let l=[];for(;t<r;)l.push(this.childString(t)),t=this.buffer[t+3];return n+"("+l.join(",")+")"}findChild(t,e,r,i,n){let{buffer:l}=this,h=-1;for(let o=t;o!=e&&!(xt(n,i,l[o+1],l[o+2])&&(h=o,r>0));o=l[o+3]);return h}slice(t,e,r,i){let n=this.buffer,l=new Uint16Array(e-t);for(let h=t,o=0;h<e;)l[o++]=n[h++],l[o++]=n[h++]-r,l[o++]=n[h++]-r,l[o++]=n[h++]-t;return new M(l,i-r,this.set)}}function xt(s,t,e,r){switch(s){case-2:return e<t;case-1:return r>=t&&e<t;case 0:return e<t&&r>t;case 1:return e<=t&&r>t;case 2:return r>t;case 4:return!0}}function yt(s,t){let e=s.childBefore(t);for(;e;){let r=e.lastChild;if(!r||r.to!=e.to)break;r.type.isError&&r.from==r.to?(s=e,e=r.prevSibling):e=r}return s}function $(s,t,e,r){for(var i;s.from==s.to||(e<1?s.from>=t:s.from>t)||(e>-1?s.to<=t:s.to<t);){let n=!r&&s instanceof O&&s.index<0?null:s.parent;if(!n)return s;s=n}if(r)for(let n=s,l=n.parent;l;n=l,l=n.parent)n instanceof O&&n.index<0&&((i=l.enter(t,e,!0))===null||i===void 0?void 0:i.from)!=n.from&&(s=l);for(;;){let n=s.enter(t,e,r);if(!n)return s;s=n}}class O{constructor(t,e,r,i){this.node=t,this._from=e,this.index=r,this._parent=i}get type(){return this.node.type}get name(){return this.node.type.name}get from(){return this._from}get to(){return this._from+this.node.length}nextChild(t,e,r,i,n=0){for(let l=this;;){for(let{children:h,positions:o}=l.node,d=e>0?h.length:-1;t!=d;t+=e){let f=h[t],g=o[t]+l._from;if(!!xt(i,r,g,g+f.length)){if(f instanceof M){if(n&2)continue;let w=f.findChild(0,f.buffer.length,e,r-g,i);if(w>-1)return new L(new Ft(l,f,t,g),null,w)}else if(n&1||!f.type.isAnonymous||ut(f)){let w;if(!(n&1)&&f.props&&(w=f.prop(m.mounted))&&!w.overlay)return new O(w.tree,g,t,l);let v=new O(f,g,t,l);return n&1||!v.type.isAnonymous?v:v.nextChild(e<0?f.children.length-1:0,e,r,i)}}}if(n&1||!l.type.isAnonymous||(l.index>=0?t=l.index+e:t=e<0?-1:l._parent.node.children.length,l=l._parent,!l))return null}}get firstChild(){return this.nextChild(0,1,0,4)}get lastChild(){return this.nextChild(this.node.children.length-1,-1,0,4)}childAfter(t){return this.nextChild(0,1,t,2)}childBefore(t){return this.nextChild(this.node.children.length-1,-1,t,-2)}enter(t,e,r=!0,i=!0){let n;if(r&&(n=this.node.prop(m.mounted))&&n.overlay){let l=t-this.from;for(let{from:h,to:o}of n.overlay)if((e>0?h<=l:h<l)&&(e<0?o>=l:o>l))return new O(n.tree,n.overlay[0].from+this.from,-1,this)}return this.nextChild(0,1,t,e,i?0:2)}nextSignificantParent(){let t=this;for(;t.type.isAnonymous&&t._parent;)t=t._parent;return t}get parent(){return this._parent?this._parent.nextSignificantParent():null}get nextSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index+1,1,0,4):null}get prevSibling(){return this._parent&&this.index>=0?this._parent.nextChild(this.index-1,-1,0,4):null}get cursor(){return new rt(this)}get tree(){return this.node}toTree(){return this.node}resolve(t,e=0){return $(this,t,e,!1)}resolveInner(t,e=0){return $(this,t,e,!0)}enterUnfinishedNodesBefore(t){return yt(this,t)}getChild(t,e=null,r=null){let i=et(this,t,e,r);return i.length?i[0]:null}getChildren(t,e=null,r=null){return et(this,t,e,r)}toString(){return this.node.toString()}}function et(s,t,e,r){let i=s.cursor,n=[];if(!i.firstChild())return n;if(e!=null){for(;!i.type.is(e);)if(!i.nextSibling())return n}for(;;){if(r!=null&&i.type.is(r))return n;if(i.type.is(t)&&n.push(i.node),!i.nextSibling())return r==null?n:[]}}class Ft{constructor(t,e,r,i){this.parent=t,this.buffer=e,this.index=r,this.start=i}}class L{constructor(t,e,r){this.context=t,this._parent=e,this.index=r,this.type=t.buffer.set.types[t.buffer.buffer[r]]}get name(){return this.type.name}get from(){return this.context.start+this.context.buffer.buffer[this.index+1]}get to(){return this.context.start+this.context.buffer.buffer[this.index+2]}child(t,e,r){let{buffer:i}=this.context,n=i.findChild(this.index+4,i.buffer[this.index+3],t,e-this.context.start,r);return n<0?null:new L(this.context,this,n)}get firstChild(){return this.child(1,0,4)}get lastChild(){return this.child(-1,0,4)}childAfter(t){return this.child(1,t,2)}childBefore(t){return this.child(-1,t,-2)}enter(t,e,r,i=!0){if(!i)return null;let{buffer:n}=this.context,l=n.findChild(this.index+4,n.buffer[this.index+3],e>0?1:-1,t-this.context.start,e);return l<0?null:new L(this.context,this,l)}get parent(){return this._parent||this.context.parent.nextSignificantParent()}externalSibling(t){return this._parent?null:this.context.parent.nextChild(this.context.index+t,t,0,4)}get nextSibling(){let{buffer:t}=this.context,e=t.buffer[this.index+3];return e<(this._parent?t.buffer[this._parent.index+3]:t.buffer.length)?new L(this.context,this._parent,e):this.externalSibling(1)}get prevSibling(){let{buffer:t}=this.context,e=this._parent?this._parent.index+4:0;return this.index==e?this.externalSibling(-1):new L(this.context,this._parent,t.findChild(e,this.index,-1,0,4))}get cursor(){return new rt(this)}get tree(){return null}toTree(){let t=[],e=[],{buffer:r}=this.context,i=this.index+4,n=r.buffer[this.index+3];if(n>i){let l=r.buffer[this.index+1],h=r.buffer[this.index+2];t.push(r.slice(i,n,l,h)),e.push(0)}return new S(this.type,t,e,this.to-this.from)}resolve(t,e=0){return $(this,t,e,!1)}resolveInner(t,e=0){return $(this,t,e,!0)}enterUnfinishedNodesBefore(t){return yt(this,t)}toString(){return this.context.buffer.childString(this.index)}getChild(t,e=null,r=null){let i=et(this,t,e,r);return i.length?i[0]:null}getChildren(t,e=null,r=null){return et(this,t,e,r)}}class rt{constructor(t,e=0){if(this.mode=e,this.buffer=null,this.stack=[],this.index=0,this.bufferNode=null,t instanceof O)this.yieldNode(t);else{this._tree=t.context.parent,this.buffer=t.context;for(let r=t._parent;r;r=r._parent)this.stack.unshift(r.index);this.bufferNode=t,this.yieldBuf(t.index)}}get name(){return this.type.name}yieldNode(t){return t?(this._tree=t,this.type=t.type,this.from=t.from,this.to=t.to,!0):!1}yieldBuf(t,e){this.index=t;let{start:r,buffer:i}=this.buffer;return this.type=e||i.set.types[i.buffer[t]],this.from=r+i.buffer[t+1],this.to=r+i.buffer[t+2],!0}yield(t){return t?t instanceof O?(this.buffer=null,this.yieldNode(t)):(this.buffer=t.context,this.yieldBuf(t.index,t.type)):!1}toString(){return this.buffer?this.buffer.buffer.childString(this.index):this._tree.toString()}enterChild(t,e,r){if(!this.buffer)return this.yield(this._tree.nextChild(t<0?this._tree.node.children.length-1:0,t,e,r,this.mode));let{buffer:i}=this.buffer,n=i.findChild(this.index+4,i.buffer[this.index+3],t,e-this.buffer.start,r);return n<0?!1:(this.stack.push(this.index),this.yieldBuf(n))}firstChild(){return this.enterChild(1,0,4)}lastChild(){return this.enterChild(-1,0,4)}childAfter(t){return this.enterChild(1,t,2)}childBefore(t){return this.enterChild(-1,t,-2)}enter(t,e,r=!0,i=!0){return this.buffer?i?this.enterChild(1,t,e):!1:this.yield(this._tree.enter(t,e,r&&!(this.mode&1),i))}parent(){if(!this.buffer)return this.yieldNode(this.mode&1?this._tree._parent:this._tree.parent);if(this.stack.length)return this.yieldBuf(this.stack.pop());let t=this.mode&1?this.buffer.parent:this.buffer.parent.nextSignificantParent();return this.buffer=null,this.yieldNode(t)}sibling(t){if(!this.buffer)return this._tree._parent?this.yield(this._tree.index<0?null:this._tree._parent.nextChild(this._tree.index+t,t,0,4,this.mode)):!1;let{buffer:e}=this.buffer,r=this.stack.length-1;if(t<0){let i=r<0?0:this.stack[r]+4;if(this.index!=i)return this.yieldBuf(e.findChild(i,this.index,-1,0,4))}else{let i=e.buffer[this.index+3];if(i<(r<0?e.buffer.length:e.buffer[this.stack[r]+3]))return this.yieldBuf(i)}return r<0?this.yield(this.buffer.parent.nextChild(this.buffer.index+t,t,0,4,this.mode)):!1}nextSibling(){return this.sibling(1)}prevSibling(){return this.sibling(-1)}atLastNode(t){let e,r,{buffer:i}=this;if(i){if(t>0){if(this.index<i.buffer.buffer.length)return!1}else for(let n=0;n<this.index;n++)if(i.buffer.buffer[n+3]<this.index)return!1;({index:e,parent:r}=i)}else({index:e,_parent:r}=this._tree);for(;r;{index:e,_parent:r}=r)if(e>-1)for(let n=e+t,l=t<0?-1:r.node.children.length;n!=l;n+=t){let h=r.node.children[n];if(this.mode&1||h instanceof M||!h.type.isAnonymous||ut(h))return!1}return!0}move(t,e){if(e&&this.enterChild(t,0,4))return!0;for(;;){if(this.sibling(t))return!0;if(this.atLastNode(t)||!this.parent())return!1}}next(t=!0){return this.move(1,t)}prev(t=!0){return this.move(-1,t)}moveTo(t,e=0){for(;(this.from==this.to||(e<1?this.from>=t:this.from>t)||(e>-1?this.to<=t:this.to<t))&&this.parent(););for(;this.enterChild(1,t,e););return this}get node(){if(!this.buffer)return this._tree;let t=this.bufferNode,e=null,r=0;if(t&&t.context==this.buffer){t:for(let i=this.index,n=this.stack.length;n>=0;){for(let l=t;l;l=l._parent)if(l.index==i){if(i==this.index)return l;e=l,r=n+1;break t}i=this.stack[--n]}}for(let i=r;i<this.stack.length;i++)e=new L(this.buffer,e,this.stack[i]);return this.bufferNode=new L(this.buffer,e,this.index)}get tree(){return this.buffer?null:this._tree.node}}function ut(s){return s.children.some(t=>t instanceof M||!t.type.isAnonymous||ut(t))}function Mt(s){var t;let{buffer:e,nodeSet:r,maxBufferLength:i=mt,reused:n=[],minRepeatType:l=r.types.length}=s,h=Array.isArray(e)?new ot(e,e.length):e,o=r.types,d=0,f=0;function g(x,y,u,c,C){let{id:p,start:a,end:k,size:P}=h,B=f;for(;P<0;)if(h.next(),P==-1){let D=n[p];u.push(D),c.push(a-x);return}else if(P==-3){d=p;return}else if(P==-4){f=p;return}else throw new RangeError(`Unrecognized record size: ${P}`);let q=o[p],E,_,pt=a-x;if(k-a<=i&&(_=R(h.pos-y,C))){let D=new Uint16Array(_.size-_.skip),I=h.pos-_.size,T=D.length;for(;h.pos>I;)T=Y(_.start,D,T);E=new M(D,k-_.start,r),pt=_.start-x}else{let D=h.pos-P;h.next();let I=[],T=[],F=p>=l?p:-1,H=0,Z=k;for(;h.pos>D;)F>=0&&h.id==F&&h.size>=0?(h.end<=Z-i&&(v(I,T,a,H,h.end,Z,F,B),H=I.length,Z=h.end),h.next()):g(a,D,I,T,F);if(F>=0&&H>0&&H<I.length&&v(I,T,a,H,a,Z,F,B),I.reverse(),T.reverse(),F>-1&&H>0){let gt=w(q);E=ft(q,I,T,0,I.length,0,k-a,gt,gt)}else E=b(q,I,T,k-a,B-k)}u.push(E),c.push(pt)}function w(x){return(y,u,c)=>{let C=0,p=y.length-1,a,k;if(p>=0&&(a=y[p])instanceof S){if(!p&&a.type==x&&a.length==c)return a;(k=a.prop(m.lookAhead))&&(C=u[p]+a.length+k)}return b(x,y,u,c,C)}}function v(x,y,u,c,C,p,a,k){let P=[],B=[];for(;x.length>c;)P.push(x.pop()),B.push(y.pop()+u-C);x.push(b(r.types[a],P,B,p-C,k-p)),y.push(C-u)}function b(x,y,u,c,C=0,p){if(d){let a=[m.contextHash,d];p=p?[a].concat(p):[a]}if(C>25){let a=[m.lookAhead,C];p=p?[a].concat(p):[a]}return new S(x,y,u,c,p)}function R(x,y){let u=h.fork(),c=0,C=0,p=0,a=u.end-i,k={size:0,start:0,skip:0};t:for(let P=u.pos-x;u.pos>P;){let B=u.size;if(u.id==y&&B>=0){k.size=c,k.start=C,k.skip=p,p+=4,c+=4,u.next();continue}let q=u.pos-B;if(B<0||q<P||u.start<a)break;let E=u.id>=l?4:0,_=u.start;for(u.next();u.pos>q;){if(u.size<0)if(u.size==-3)E+=4;else break t;else u.id>=l&&(E+=4);u.next()}C=_,c+=B,p+=E}return(y<0||c==x)&&(k.size=c,k.start=C,k.skip=p),k.size>4?k:void 0}function Y(x,y,u){let{id:c,start:C,end:p,size:a}=h;if(h.next(),a>=0&&c<l){let k=u;if(a>4){let P=h.pos-(a-4);for(;h.pos>P;)u=Y(x,y,u)}y[--u]=k,y[--u]=p-x,y[--u]=C-x,y[--u]=c}else a==-3?d=c:a==-4&&(f=c);return u}let W=[],V=[];for(;h.pos>0;)g(s.start||0,s.bufferStart||0,W,V,-1);let A=(t=s.length)!==null&&t!==void 0?t:W.length?V[0]+W[0].length:0;return new S(o[s.topID],W.reverse(),V.reverse(),A)}const kt=new WeakMap;function it(s,t){if(!s.isAnonymous||t instanceof M||t.type!=s)return 1;let e=kt.get(t);if(e==null){e=1;for(let r of t.children){if(r.type!=s||!(r instanceof S)){e=1;break}e+=it(s,r)}kt.set(t,e)}return e}function ft(s,t,e,r,i,n,l,h,o){let d=0;for(let b=r;b<i;b++)d+=it(s,t[b]);let f=Math.ceil(d*1.5/8),g=[],w=[];function v(b,R,Y,W,V){for(let A=Y;A<W;){let x=A,y=R[A],u=it(s,b[A]);for(A++;A<W;A++){let c=it(s,b[A]);if(u+c>=f)break;u+=c}if(A==x+1){if(u>f){let c=b[x];v(c.children,c.positions,0,c.children.length,R[x]+V);continue}g.push(b[x])}else{let c=R[A-1]+b[A-1].length-y;g.push(ft(s,b,R,x,A,y,c,null,o))}w.push(y+V-n)}}return v(t,e,r,i,0),(h||o)(g,w,l)}class j{constructor(t,e,r,i,n=!1,l=!1){this.from=t,this.to=e,this.tree=r,this.offset=i,this.open=(n?1:0)|(l?2:0)}get openStart(){return(this.open&1)>0}get openEnd(){return(this.open&2)>0}static addTree(t,e=[],r=!1){let i=[new j(0,t.length,t,0,!1,r)];for(let n of e)n.to>t.length&&i.push(n);return i}static applyChanges(t,e,r=128){if(!e.length)return t;let i=[],n=1,l=t.length?t[0]:null;for(let h=0,o=0,d=0;;h++){let f=h<e.length?e[h]:null,g=f?f.fromA:1e9;if(g-o>=r)for(;l&&l.from<g;){let w=l;if(o>=w.from||g<=w.to||d){let v=Math.max(w.from,o)-d,b=Math.min(w.to,g)-d;w=v>=b?null:new j(v,b,w.tree,w.offset+d,h>0,!!f)}if(w&&i.push(w),l.to>g)break;l=n<t.length?t[n++]:null}if(!f)break;o=f.toA,d=f.toA-f.toB}return i}}class bt{startParse(t,e,r){return typeof t=="string"&&(t=new jt(t)),r=r?r.length?r.map(i=>new lt(i.from,i.to)):[new lt(0,0)]:[new lt(0,t.length)],this.createParse(t,e||[],r)}parse(t,e,r){let i=this.startParse(t,e,r);for(;;){let n=i.advance();if(n)return n}}}class jt{constructor(t){this.string=t}get length(){return this.string.length}chunk(t){return this.string.slice(t)}get lineChunks(){return!1}read(t,e){return this.string.slice(t,e)}}const oe=new m({perNode:!0}),nt=new m;function Ut(s){return Q.define({combine:s?t=>t.concat(s):void 0})}class z{constructor(t,e,r,i=[]){this.data=t,this.topNode=r,K.prototype.hasOwnProperty("tree")||Object.defineProperty(K.prototype,"tree",{get(){return J(this)}}),this.parser=e,this.extension=[U.of(this),K.languageData.of((n,l,h)=>n.facet(Ct(n,l,h)))].concat(i)}isActiveAt(t,e,r=-1){return Ct(t,e,r)==this.data}findRegions(t){let e=t.facet(U);if((e==null?void 0:e.data)==this.data)return[{from:0,to:t.doc.length}];if(!e||!e.allowsNesting)return[];let r=[],i=(n,l)=>{if(n.prop(nt)==this.data){r.push({from:l,to:l+n.length});return}let h=n.prop(m.mounted);if(h){if(h.tree.prop(nt)==this.data){if(h.overlay)for(let o of h.overlay)r.push({from:o.from+l,to:o.to+l});else r.push({from:l,to:l+n.length});return}else if(h.overlay){let o=r.length;if(i(h.tree,h.overlay[0].from+l),r.length>o)return}}for(let o=0;o<n.children.length;o++){let d=n.children[o];d instanceof S&&i(d,n.positions[o]+l)}};return i(J(t),0),r}get allowsNesting(){return!0}}z.setState=Ot.define();function Ct(s,t,e){let r=s.facet(U);if(!r)return null;let i=r.data;if(r.allowsNesting)for(let n=J(s).topNode;n;n=n.enter(t,e,!0,!1))i=n.type.prop(nt)||i;return i}class st extends z{constructor(t,e){super(t,e,e.topNode);this.parser=e}static define(t){let e=Ut(t.languageData);return new st(e,t.parser.configure({props:[nt.add(r=>r.isTop?e:void 0)]}))}configure(t){return new st(this.data,this.parser.configure(t))}get allowsNesting(){return this.parser.wrappers.length>0}}function J(s){let t=s.field(z.state,!1);return t?t.tree:S.empty}class Rt{constructor(t,e=t.length){this.doc=t,this.length=e,this.cursorPos=0,this.string="",this.cursor=t.iter()}syncTo(t){return this.string=this.cursor.next(t-this.cursorPos).value,this.cursorPos=t+this.string.length,this.cursorPos-this.string.length}chunk(t){return this.syncTo(t),this.string}get lineChunks(){return!0}read(t,e){let r=this.cursorPos-this.string.length;return t<r||e>=this.cursorPos?this.doc.sliceString(t,e):this.string.slice(t-r,e-r)}}let X=null;class at{constructor(t,e,r=[],i,n,l,h,o){this.parser=t,this.state=e,this.fragments=r,this.tree=i,this.treeLen=n,this.viewport=l,this.skipped=h,this.scheduleOn=o,this.parse=null,this.tempSkipped=[]}startParse(){return this.parser.startParse(new Rt(this.state.doc),this.fragments)}work(t,e){return e!=null&&e>=this.state.doc.length&&(e=void 0),this.tree!=S.empty&&this.isDone(e??this.state.doc.length)?(this.takeTree(),!0):this.withContext(()=>{var r;let i=Date.now()+t;for(this.parse||(this.parse=this.startParse()),e!=null&&(this.parse.stoppedAt==null||this.parse.stoppedAt>e)&&e<this.state.doc.length&&this.parse.stopAt(e);;){let n=this.parse.advance();if(n)if(this.fragments=this.withoutTempSkipped(j.addTree(n,this.fragments,this.parse.stoppedAt!=null)),this.treeLen=(r=this.parse.stoppedAt)!==null&&r!==void 0?r:this.state.doc.length,this.tree=n,this.parse=null,this.treeLen<(e??this.state.doc.length))this.parse=this.startParse();else return!0;if(Date.now()>i)return!1}})}takeTree(){let t,e;this.parse&&(t=this.parse.parsedPos)>=this.treeLen&&((this.parse.stoppedAt==null||this.parse.stoppedAt>t)&&this.parse.stopAt(t),this.withContext(()=>{for(;!(e=this.parse.advance()););}),this.treeLen=t,this.tree=e,this.fragments=this.withoutTempSkipped(j.addTree(this.tree,this.fragments,!0)),this.parse=null)}withContext(t){let e=X;X=this;try{return t()}finally{X=e}}withoutTempSkipped(t){for(let e;e=this.tempSkipped.pop();)t=St(t,e.from,e.to);return t}changes(t,e){let{fragments:r,tree:i,treeLen:n,viewport:l,skipped:h}=this;if(this.takeTree(),!t.empty){let o=[];if(t.iterChangedRanges((d,f,g,w)=>o.push({fromA:d,toA:f,fromB:g,toB:w})),r=j.applyChanges(r,o),i=S.empty,n=0,l={from:t.mapPos(l.from,-1),to:t.mapPos(l.to,1)},this.skipped.length){h=[];for(let d of this.skipped){let f=t.mapPos(d.from,1),g=t.mapPos(d.to,-1);f<g&&h.push({from:f,to:g})}}}return new at(this.parser,e,r,i,n,l,h,this.scheduleOn)}updateViewport(t){if(this.viewport.from==t.from&&this.viewport.to==t.to)return!1;this.viewport=t;let e=this.skipped.length;for(let r=0;r<this.skipped.length;r++){let{from:i,to:n}=this.skipped[r];i<t.to&&n>t.from&&(this.fragments=St(this.fragments,i,n),this.skipped.splice(r--,1))}return this.skipped.length>=e?!1:(this.reset(),!0)}reset(){this.parse&&(this.takeTree(),this.parse=null)}skipUntilInView(t,e){this.skipped.push({from:t,to:e})}static getSkippingParser(t){return new class extends bt{createParse(e,r,i){let n=i[0].from,l=i[i.length-1].to;return{parsedPos:n,advance(){let o=X;if(o){for(let d of i)o.tempSkipped.push(d);t&&(o.scheduleOn=o.scheduleOn?Promise.all([o.scheduleOn,t]):t)}return this.parsedPos=l,new S(N.none,[],[],l-n)},stoppedAt:null,stopAt(){}}}}}isDone(t){t=Math.min(t,this.state.doc.length);let e=this.fragments;return this.treeLen>=t&&e.length&&e[0].from==0&&e[0].to>=t}static get(){return X}}function St(s,t,e){return j.applyChanges(s,[{fromA:t,toA:e,fromB:t,toB:e}])}class G{constructor(t){this.context=t,this.tree=t.tree}apply(t){if(!t.docChanged)return this;let e=this.context.changes(t.changes,t.state),r=this.context.treeLen==t.startState.doc.length?void 0:Math.max(t.changes.mapPos(this.context.treeLen),e.viewport.to);return e.work(20,r)||e.takeTree(),new G(e)}static init(t){let e=Math.min(3e3,t.doc.length),r=new at(t.facet(U).parser,t,[],S.empty,0,{from:0,to:e},[],null);return r.work(20,e)||r.takeTree(),new G(r)}}z.state=Tt.define({create:G.init,update(s,t){for(let e of t.effects)if(e.is(z.setState))return e.value;return t.startState.facet(U)!=t.state.facet(U)?G.init(t.state):s.apply(t)}});let vt=s=>{let t=setTimeout(()=>s(),500);return()=>clearTimeout(t)};typeof requestIdleCallback!="undefined"&&(vt=s=>{let t=-1,e=setTimeout(()=>{t=requestIdleCallback(s,{timeout:500-100})},100);return()=>t<0?clearTimeout(e):cancelIdleCallback(t)});const Vt=Et.fromClass(class{constructor(t){this.view=t,this.working=null,this.workScheduled=0,this.chunkEnd=-1,this.chunkBudget=-1,this.work=this.work.bind(this),this.scheduleWork()}update(t){let e=this.view.state.field(z.state).context;(e.updateViewport(t.view.viewport)||this.view.viewport.to>e.treeLen)&&this.scheduleWork(),t.docChanged&&(this.view.hasFocus&&(this.chunkBudget+=50),this.scheduleWork()),this.checkAsyncSchedule(e)}scheduleWork(){if(this.working)return;let{state:t}=this.view,e=t.field(z.state);(e.tree!=e.context.tree||!e.context.isDone(t.doc.length))&&(this.working=vt(this.work))}work(t){this.working=null;let e=Date.now();if(this.chunkEnd<e&&(this.chunkEnd<0||this.view.hasFocus)&&(this.chunkEnd=e+3e4,this.chunkBudget=3e3),this.chunkBudget<=0)return;let{state:r,viewport:{to:i}}=this.view,n=r.field(z.state);if(n.tree==n.context.tree&&n.context.isDone(i+1e5))return;let l=Math.min(this.chunkBudget,100,t?Math.max(25,t.timeRemaining()-5):1e9),h=n.context.treeLen<i&&r.doc.length>i+1e3,o=n.context.work(l,i+(h?0:1e5));this.chunkBudget-=Date.now()-e,(o||this.chunkBudget<=0)&&(n.context.takeTree(),this.view.dispatch({effects:z.setState.of(new G(n.context))})),this.chunkBudget>0&&!(o&&!h)&&this.scheduleWork(),this.checkAsyncSchedule(n.context)}checkAsyncSchedule(t){t.scheduleOn&&(this.workScheduled++,t.scheduleOn.then(()=>this.scheduleWork()).catch(e=>Dt(this.view.state,e)).then(()=>this.workScheduled--),t.scheduleOn=null)}destroy(){this.working&&this.working()}isWorking(){return this.working||this.workScheduled>0}},{eventHandlers:{focus(){this.scheduleWork()}}}),U=Q.define({combine(s){return s.length?s[0]:null},enables:[z.state,Vt]});class qt{constructor(t,e=[]){this.language=t,this.support=e,this.extension=[t,e]}}const Ht=Q.define(),dt=Q.define({combine:s=>{if(!s.length)return"  ";if(!/^(?: +|\t+)$/.test(s[0]))throw new Error("Invalid indent unit: "+JSON.stringify(s[0]));return s[0]}});function At(s){let t=s.facet(dt);return t.charCodeAt(0)==9?s.tabSize*t.length:t.length}function Pt(s,t){let e="",r=s.tabSize;if(s.facet(dt).charCodeAt(0)==9)for(;t>=r;)e+="	",t-=r;for(let i=0;i<t;i++)e+=" ";return e}function Nt(s,t){s instanceof K&&(s=new ct(s));for(let r of s.state.facet(Ht)){let i=r(s,t);if(i!=null)return i}let e=J(s.state);return e?$t(s,e,t):null}class ct{constructor(t,e={}){this.state=t,this.options=e,this.unit=At(t)}lineAt(t,e=1){let r=this.state.doc.lineAt(t),{simulateBreak:i}=this.options;return i!=null&&i>=r.from&&i<=r.to?(e<0?i<t:i<=t)?{text:r.text.slice(i-r.from),from:i}:{text:r.text.slice(0,i-r.from),from:r.from}:r}textAfterPos(t,e=1){if(this.options.simulateDoubleBreak&&t==this.options.simulateBreak)return"";let{text:r,from:i}=this.lineAt(t,e);return r.slice(t-i,Math.min(r.length,t+100-i))}column(t,e=1){let{text:r,from:i}=this.lineAt(t,e),n=this.countColumn(r,t-i),l=this.options.overrideIndentation?this.options.overrideIndentation(i):-1;return l>-1&&(n+=l-this.countColumn(r,r.search(/\S|$/))),n}countColumn(t,e=t.length){return _t(t,this.state.tabSize,e)}lineIndent(t,e=1){let{text:r,from:i}=this.lineAt(t,e),n=this.options.overrideIndentation;if(n){let l=n(i);if(l>-1)return l}return this.countColumn(r,r.search(/\S|$/))}get simulatedBreak(){return this.options.simulateBreak||null}}const Bt=new m;function $t(s,t,e){return It(t.resolveInner(e).enterUnfinishedNodesBefore(e),e,s)}function Jt(s){return s.pos==s.options.simulateBreak&&s.options.simulateDoubleBreak}function Gt(s){let t=s.type.prop(Bt);if(t)return t;let e=s.firstChild,r;if(e&&(r=e.type.prop(m.closedBy))){let i=s.lastChild,n=i&&r.indexOf(i.name)>-1;return l=>Zt(l,!0,1,void 0,n&&!Jt(l)?i.from:void 0)}return s.parent==null?Kt:null}function It(s,t,e){for(;s;s=s.parent){let r=Gt(s);if(r)return r(new Qt(e,t,s))}return null}function Kt(){return 0}class Qt extends ct{constructor(t,e,r){super(t.state,t.options);this.base=t,this.pos=e,this.node=r}get textAfter(){return this.textAfterPos(this.pos)}get baseIndent(){let t=this.state.doc.lineAt(this.node.from);for(;;){let e=this.node.resolve(t.from);for(;e.parent&&e.parent.from==e.from;)e=e.parent;if(Xt(e,this.node))break;t=this.state.doc.lineAt(e.from)}return this.lineIndent(t.from)}continue(){let t=this.node.parent;return t?It(t,this.pos,this.base):0}}function Xt(s,t){for(let e=t;e;e=e.parent)if(s==e)return!0;return!1}function Yt(s){let t=s.node,e=t.childAfter(t.from),r=t.lastChild;if(!e)return null;let i=s.options.simulateBreak,n=s.state.doc.lineAt(e.from),l=i==null||i<=n.from?n.to:Math.min(n.to,i);for(let h=e.to;;){let o=t.childAfter(h);if(!o||o==r)return null;if(!o.type.isSkipped)return o.from<l?e:null;h=o.to}}function Zt(s,t,e,r,i){let n=s.textAfter,l=n.match(/^\s*/)[0].length,h=r&&n.slice(l,l+r.length)==r||i==s.pos+l,o=t?Yt(s):null;return o?h?s.column(o.from):s.column(o.to):s.baseIndent+(h?0:s.unit*e)}function te({except:s,units:t=1}={}){return e=>{let r=s&&s.test(e.textAfter);return e.baseIndent+(r?0:t*e.unit)}}const ee=200;function re(){return K.transactionFilter.of(s=>{if(!s.docChanged||!s.isUserEvent("input.type"))return s;let t=s.startState.languageDataAt("indentOnInput",s.startState.selection.main.head);if(!t.length)return s;let e=s.newDoc,{head:r}=s.newSelection.main,i=e.lineAt(r);if(r>i.from+ee)return s;let n=e.sliceString(i.from,r);if(!t.some(d=>d.test(n)))return s;let{state:l}=s,h=-1,o=[];for(let{head:d}of l.selection.ranges){let f=l.doc.lineAt(d);if(f.from==h)continue;h=f.from;let g=Nt(l,f.from);if(g==null)continue;let w=/^\s*/.exec(f.text)[0],v=Pt(l,g);w!=v&&o.push({from:f.from,to:f.from+w.length,insert:v})}return o.length?[s,{changes:o,sequential:!0}]:s})}const ie=Q.define(),zt=new m;function ne(s){let t=s.firstChild,e=s.lastChild;return t&&t.to<e.from?{from:t.to,to:e.type.isError?s.to:e.from}:null}function se(s,t,e){let r=J(s);if(r.length==0)return null;let i=r.resolveInner(e),n=null;for(let l=i;l;l=l.parent){if(l.to<=e||l.from>e)continue;if(n&&l.from<t)break;let h=l.type.prop(zt);if(h){let o=h(l,s);o&&o.from<=e&&o.from>=t&&o.to>e&&(n=o)}}return n}function le(s,t,e){for(let r of s.facet(ie)){let i=r(s,t,e);if(i)return i}return se(s,t,e)}export{mt as D,ct as I,qt as L,m as N,bt as P,S as T,Pt as a,Nt as b,dt as c,N as d,ht as e,le as f,At as g,st as h,re as i,Bt as j,te as k,U as l,zt as m,ne as n,J as s};
